generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. User
model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  role      Role      @default(SOCIO)
  status    UserStatus @default(PENDING)
  
  mfaEnabled Boolean   @default(false)
  mfaSecret  String?   // TOTP Secret
  lastLogin  DateTime?
  
  associationId Int?   // Tenant ID
  association   Association? @relation(fields: [associationId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft Delete

  profile            Profile?
  financialRecords   FinancialRecord[]
  eventRegistrations EventRegistration[]
  signatures         DocumentSignature[]
  dependents         Dependent[]
}

enum Role {
  ADMIN
  DIRETOR
  SOCIO
  GLOBAL_ADMIN
  ASSOCIATION_ADMIN
  FINANCIAL_OP
  COMMUNICATION_OP
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum AssociationStatus {
  ACTIVE
  INACTIVE
  TEST
  DEFAULTER
}

model Association {
  id          Int      @id @default(autoincrement())
  name        String
  logoLight   String?  // URL or Base64 (Light Mode)
  logoDark    String?  // URL or Base64 (Dark Mode)
  primaryColor String? @default("#2563eb") // Hex Color (Default Blue)
  cnpj        String?  @unique
  status      AssociationStatus @default(ACTIVE)

  // Address
  zipCode     String?
  street      String?
  number      String?
  district    String?
  city        String?
  state       String?

  // Contact
  whatsapp    String?
  email       String?

  // System
  activeModules Json? // Custom modules config per association
  settings      Json? // Custom settings (e.g., suspensionGracePeriod)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users        User[]
  cashFlows    CashFlowEntry[] @relation("CashFlowAssociation")
  logs         FinancialLog[]  @relation("LogAssociation")
  categories   Category[]      @relation("CategoryAssociation")
}

// 2. Profile
model Profile {
  id              Int        @id @default(autoincrement())
  type            PersonType @default(PF)
  
  // Common / PF Fields
  fullName        String?    // Nome completo (PF) ou Razão Social (PJ - ou usar campo específico)
  cpf             String?    @unique // PF
  birthDate       DateTime?  // PF
  phone           String?    // PF/PJ
  
  // PJ Fields
  socialReason    String?    // Razão Social
  fantasyName     String?    // Nome Fantasia
  cnpj            String?    @unique // PJ
  stateRegistration String?  // Inscrição Estadual
  responsibleName String?    // Nome Responsável
  responsibleCpf  String?    // CPF Responsável

  // Address
  zipCode         String?
  street          String?
  number          String?
  complement      String?
  district        String?
  city            String?
  state           String?

  // Professional (PF)
  education            String? // Formação Acadêmica
  professionalRegistry String? // Registro Profissional (CREA/CAU)
  currentCompany       String? // Empresa onde trabalha
  jobRole              String? // Área de Atuação

  // Company Data (PJ)
  activityBranch       String? // Ramo de Atividade
  employeeCount        Int?    // Número de Funcionários
  website              String? // Site da Empresa

  // Extra
  bio             String? @db.Text
  skills          String? @db.Text
  socialLinks     Json?   // Links sociais
  isPublicConsent Boolean @default(false)
  
  // Documents (Paths)
  docRgCnh              String?
  docCpf                String?
  docDiploma            String?
  docProfessionalRegistry String?
  docSocialContract     String?
  docCnpjCard           String?
  docResponsibleRg      String?
  docPartnerPhoto       String?

  userId          Int     @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum PersonType {
  PF
  PJ
}

model Dependent {
  id        Int      @id @default(autoincrement())
  name      String
  kinship   Kinship
  birthDate DateTime
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Kinship {
  CONJUGE
  FILHO
}

// 3. FinancialRecord
model FinancialRecord {
  id          Int             @id @default(autoincrement())
  type        FinancialType   // Mensalidades ou Cobranças Avulsas
  description String?
  amount      Decimal         @db.Decimal(10, 2)
  dueDate     DateTime        // Vencimento
  status      FinancialStatus @default(PENDING)
  
  userId      Int
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

enum FinancialType {
  MENSALIDADE
  AVULSA
}

enum FinancialStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

// 4. Event
model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  date        DateTime
  prices      Json     // Preços em JSON para sócio/público
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  registrations EventRegistration[]
}

// 5. EventRegistration
model EventRegistration {
  id        Int                @id @default(autoincrement())
  status    RegistrationStatus @default(REGISTERED) // Status de check-in
  checkInAt DateTime?
  
  userId    Int
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId   Int
  event     Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@unique([userId, eventId])
}

enum RegistrationStatus {
  REGISTERED
  CHECKED_IN
  CANCELLED
}

// 6. DocumentAta
model DocumentAta {
  id        Int                 @id @default(autoincrement())
  pdfPath   String
  status    String              // Status do documento
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  signatures DocumentSignature[]
}

model DocumentSignature {
  id         Int         @id @default(autoincrement())
  signedAt   DateTime    @default(now())
  
  userId     Int
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentId Int
  document   DocumentAta @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([userId, documentId])
}

// 7. CashFlow
model CashFlowEntry {
  id          Int          @id @default(autoincrement())
  description String
  amount      Decimal      @db.Decimal(10, 2)
  date        DateTime
  type        CashFlowType // IN (Entrada), OUT (Saída)
  
  category    String?      // Mantendo campo legado para compatibilidade se necessário, mas...
  categoryId  Int?         // Nova relação
  categoryRef Category?    @relation(fields: [categoryId], references: [id])
  
  operatorId  Int?         // Usuário que realizou o lançamento
  operatorName String?     // Nome do operador no momento do lançamento

  associationId Int?       // Tenant ID
  association   Association? @relation("CashFlowAssociation", fields: [associationId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model FinancialLog {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime @default(now())
  userId      Int      // Quem realizou a ação
  userName    String   // Nome do usuário logado
  action      String   // CREATE, UPDATE, DELETE
  entityType  String   // CASH_FLOW, CATEGORY, etc
  entityId    Int      // ID do registro afetado
  oldValue    Json?    // Valores anteriores (para UPDATES)
  newValue    Json?    // Valores novos (para UPDATES/CREATES)
  description String?  // Descrição amigável da ação

  associationId Int?   // Tenant ID
  association   Association? @relation("LogAssociation", fields: [associationId], references: [id])

  @@index([timestamp])
}

model Category {
  id        Int          @id @default(autoincrement())
  name      String
  color     String       // Hex color for charts
  type      CashFlowType // IN or OUT
  entries   CashFlowEntry[]
  
  associationId Int?     // Tenant ID
  association   Association? @relation("CategoryAssociation", fields: [associationId], references: [id])

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

enum CashFlowType {
  IN
  OUT
}
// ... (previous content)

// 12. Monthly Closure
model MonthlyClosure {
  id           Int       @id @default(autoincrement())
  month        Int
  year         Int
  status       String    @default("OPEN") // 'OPEN' or 'CLOSED'
  
  closedAt     DateTime?
  closedBy     Int?      // User ID
  
  reopenedAt   DateTime?
  reopenedBy   Int?      // User ID
  reopenReason String?   @db.Text
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([month, year])
}

// 13. System Settings (SaaS Feature Flags)
model SystemSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique // e.g., "SAAS_FEATURES"
  value     Json     // Stores { SITE: true, PORTAL_SOCIO: false, ... }
  updatedAt DateTime @updatedAt
}
